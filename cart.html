<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Корзина — Pryles Shop</title>
  <meta name="description" content="Корзина для ваших покупок" />

  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
  (function(m,e,t,r,i,k,a){
    m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
  })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106875241', 'ym');

  ym(106875241, 'init', {
    ssr:true,
    webvisor:true,
    clickmap:true,
    ecommerce:"dataLayer",
    accurateTrackBounce:true,
    trackLinks:true
  });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/106875241" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S6CLFHHDGH"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S6CLFHHDGH');
  </script>
  <!-- /Google tag -->
</head>

<body style="margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
background:
radial-gradient(700px 420px at 20% 10%, rgba(255,79,179,0.18), transparent 60%),
radial-gradient(620px 380px at 85% 15%, rgba(255,134,207,0.12), transparent 60%),
#0b0c10;
color:#f6f7fb;">

  <div style="max-width:980px; margin:0 auto; padding:32px 16px 60px;">
    <div style="padding:22px; border-radius:18px; background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,79,179,0.30); box-shadow:0 12px 36px rgba(0,0,0,0.45);">

      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <h1 style="margin:0; color:#fff;">Корзина</h1>
        <a href="./index.html" style="display:inline-block; border-radius:14px; padding:10px 14px; font-weight:800;
          color:#fff; text-decoration:none; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06);">
          На главную
        </a>
      </div>

      <p style="opacity:.85; margin:10px 0 16px; line-height:1.45;">
        Просто покликай кнопки, это для учебы :)
      </p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
        <button id="clearCartBtn"
          style="cursor:pointer; border:0; border-radius:14px; padding:10px 14px; font-weight:900;
          background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.18);">
          Очистить корзину
        </button>

        <a href="./details.html" id="backToDetails"
          style="display:inline-block; border-radius:14px; padding:10px 14px; font-weight:900;
          color:#fff; text-decoration:none; border:1px solid rgba(255,79,179,0.45); background:rgba(255,79,179,0.14);">
          Вернуться к товару
        </a>
      </div>

      <div id="cartSummary"
        style="padding:14px; border-radius:16px; background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,79,179,0.28); display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:850;">
          Товаров: <b id="cartCount">0</b>
        </div>
        <div style="font-weight:850;">
          Сумма: <b id="cartTotal">0</b> ₽
        </div>
      </div>

      <div id="cartItems"
        style="margin-top:14px; display:flex; flex-direction:column; gap:10px;">

        <!-- items render here -->
      </div>

      <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
        <button id="checkoutBtn"
          style="cursor:pointer; border:0; border-radius:14px; padding:12px 16px; font-weight:900;
          background:linear-gradient(135deg,#ff4fb3,#ff86cf); color:#0b0c10;">
          Оформить покупку
        </button>
      </div>

      
    </div>
  </div>

<script>

  const MID = 106875241;
  const variant = Math.random() < 0.5 ? 'A' : 'B'; // рандом каждый заход, как ты хочешь

  const CART_KEY = 'minishop_cart_v1';

  function loadCart() {
    try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
    catch { return []; }
  }
  function saveCart(cart) { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
  function totals(cart) {
    const count = cart.reduce((s, it) => s + it.qty, 0);
    const total = cart.reduce((s, it) => s + it.qty * it.price, 0);
    return { count, total };
  }

  function fireM(goal, params = {}) {
    try { window.ym && window.ym(MID,'reachGoal',goal, params); } catch(e) {}
  }

  function fireGA(name, params = {}) {
    try {
      window.gtag && gtag('event', name, {
        page_name: 'cart',
        page_path: location.pathname,
        variant,
        ...params
      });
    } catch(e) {}
  }

  const cartCount = document.getElementById('cartCount');
  const cartTotal = document.getElementById('cartTotal');
  const cartItems = document.getElementById('cartItems');
  const clearCartBtn = document.getElementById('clearCartBtn');
  const checkoutBtn = document.getElementById('checkoutBtn');

  function render() {
    const cart = loadCart();
    const { count, total } = totals(cart);

    cartCount.textContent = String(count);
    cartTotal.textContent = String(total);

    if (cart.length === 0) {
      cartItems.innerHTML = `
        <div style="padding:14px; border-radius:14px; background:rgba(255,255,255,0.05);
          border:1px solid rgba(255,255,255,0.12); opacity:.9;">
          Корзина пустая. Добавь товар на странице “Подробнее”.
        </div>`;
      return;
    }

    cartItems.innerHTML = cart.map((it, idx) => `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
        padding:12px; border-radius:14px; background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.12);">
        <div>
          <div style="font-weight:850;">${it.name}</div>
          <div style="font-size:13px; opacity:.85;">${it.price} ₽ · Кол-во: <b>${it.qty}</b></div>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <button data-action="minus" data-idx="${idx}"
            style="cursor:pointer; border:0; border-radius:12px; padding:8px 10px; font-weight:900;
            background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.16);">−</button>

          <button data-action="plus" data-idx="${idx}"
            style="cursor:pointer; border:0; border-radius:12px; padding:8px 10px; font-weight:900;
            background:rgba(255,79,179,0.18); color:#fff; border:1px solid rgba(255,79,179,0.35);">+</button>

          <button data-action="remove" data-idx="${idx}"
            style="cursor:pointer; border:0; border-radius:12px; padding:8px 10px; font-weight:900;
            background:rgba(255,255,255,0.06); color:#fff; border:1px solid rgba(255,255,255,0.16);">Удалить</button>
        </div>
      </div>
    `).join('');
  }

  // =========================
  // 1) VIEW CART (при открытии корзины)
  // =========================
  (function trackViewCart(){
    const cart = loadCart();
    const { count, total } = totals(cart);

    fireGA('view_cart', { items_count: count, value: total, currency: 'RUB' });
    fireM('view_cart', { variant });
  })();

  // =========================
  // 2) Обработчики внутри списка товаров
  // =========================
  cartItems.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const action = btn.getAttribute('data-action');
    const idx = Number(btn.getAttribute('data-idx'));

    const cart = loadCart();
    if (!cart[idx]) return;

    const item = cart[idx];

    if (action === 'plus') {
      item.qty += 1;

      fireGA('add_to_cart', { item_id: item.id, item_name: item.name, price: item.price, qty: 1 });
      fireM('add_to_cart', { variant });

    } else if (action === 'minus') {
      item.qty -= 1;

      // если уменьшаем — это логически remove_from_cart (удаление 1 единицы)
      fireGA('remove_from_cart', { item_id: item.id, item_name: item.name, price: item.price, qty: 1 });
      fireM('remove_from_cart', { variant });

      if (item.qty <= 0) cart.splice(idx, 1);

    } else if (action === 'remove') {
      // удаляем весь товар целиком
      fireGA('remove_from_cart', { item_id: item.id, item_name: item.name, price: item.price, qty: item.qty });
      fireM('remove_from_cart', { variant });

      cart.splice(idx, 1);
    }

    saveCart(cart);
    render();
  });

  // =========================
  // 3) Очистить корзину
  // =========================
  clearCartBtn.addEventListener('click', () => {
    saveCart([]);

    fireGA('cart_clear');
    fireM('cart_clear');

    render();
  });

  // =========================
  // 4) Оформить покупку (DEMO PURCHASE)
  // =========================
  checkoutBtn.addEventListener('click', () => {
    const cart = loadCart();
    const { count, total } = totals(cart);

    // "покупка" (демо)
    fireGA('purchase', {
      transaction_id: 'demo_' + Date.now(),
      value: total,
      currency: 'RUB',
      items_count: count
    });
    fireM('purchase', { variant });

    alert('Оформление заказа (демо).');

    // по желанию: очищаем корзину после "покупки"
    // saveCart([]);
    // render();
  });

  // init render
  render();
</script>
</body>
</html>
